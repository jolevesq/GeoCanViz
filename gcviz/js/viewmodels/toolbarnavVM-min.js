(function(){define(["jquery-private","knockout","gcviz-i18n","gcviz-func","gcviz-gismap","gcviz-gisgeo","gcviz-gisnav","gcviz-gisdatagrid","gcviz-gisgraphic"],function(d,j,l,h,g,k,e,i,c){var b,f=false,a;b=function(p,n,o){var m=function(v,C){var D=this,B,t,z=o.geolocation,F=o.overview,u=o.scaledisplay,x=v.find("#inGeoLocation"+C),s=v.find("#btnClickMap"+C),E=d("#"+C+"_holder_layers"),A=d("#ovmapcont"+C),r=d("#gcviz-menu"+C),G=d("#gcviz-menu-cont"+C),w=v.find("#gcviz-pos"+C),q=h.getElemValueVM(C,["map","map"],"js"),y=[{minx:0,miny:0,maxx:0,maxy:0,title:"ddd"}];D.mapid=C;D.langCode=l.getDict("%lang-code");D.langSep=D.langCode==="en"?",":" ";D.cancel=l.getDict("%cancel");D.close=l.getDict("%close");D.cursorTarget=l.getDict("%cursor-target");D.geoLocLabel=l.getDict("%toolbarnav-lblgeoloc");D.geoLocUrl=l.getDict("%gisurllocate");D.OVLabel=l.getDict("%toolbarnav-lblov");D.OVDisplayLabel=l.getDict("%toolbarnav-lblovdisplay");D.infoLabel=l.getDict("%toolbarnav-lblinfo");D.info=l.getDict("%toolbarnav-info");D.infoAltitude=l.getDict("%toolbarnav-infoaltitude");D.infoDecDeg=l.getDict("%toolbarnav-infodecdeg");D.infoDMS=l.getDict("%toolbarnav-infodms");D.infoLat=l.getDict("%lat");D.infoLong=l.getDict("%long");D.infoNTS=l.getDict("%toolbarnav-infonts");D.infoTopoCoord=l.getDict("%toolbarnav-infotopocoord");D.infoUTM=l.getDict("%toolbarnav-infoutm");D.infoUTMeast=l.getDict("%toolbarnav-infoutmeast");D.infoUTMnorth=l.getDict("%toolbarnav-infoutmnorth");D.infoUTMz=l.getDict("%toolbarnav-infoutmz");D.insKeyboard=l.getDict("%toolbarnav-inskeyboard");D.tpGetLocInfo=l.getDict("%toolbarnav-info");D.tpOverview=l.getDict("%toolbarnav-ovdrag");D.lblWest=l.getDict("%west");D.lblLocTitle=l.getDict("%toolbarnav-info");D.lblScale=j.observable(l.getDict("%toolbarnav-scale"));D.ScaleLabel=D.lblScale();D.zoomGrp=l.getDict("%toolbarnav-zoomgrp");D.mapInfoGrp=l.getDict("%toolbarnav-mapinfogrp");D.WCAGTitle=l.getDict("%wcag-title");D.lblWCAGx=l.getDict("%wcag-xlong");D.lblWCAGy=l.getDict("%wcag-ylat");D.lblWCAGmsgx=l.getDict("%wcag-msgx");D.lblWCAGmsgy=l.getDict("%wcag-msgy");D.xValue=j.observable().extend({numeric:{precision:3,validation:{min:50,max:130}}});D.yValue=j.observable().extend({numeric:{precision:3,validation:{min:40,max:80}}});D.isWCAG=j.observable(false);D.isDialogWCAG=j.observable(false);D.wcagok=false;D.defaultAutoComplText=l.getDict("%toolbarnav-geolocsample");D.geoLocSample=l.getDict("%toolbarnav-geolocsample");D.isOVShowMap=j.observable(false);D.infoLatDD=j.observable();D.infoLatDMS=j.observable();D.infoLongDD=j.observable();D.infoLongDMS=j.observable();D.isToolsOpen=j.observable(false);D.spnAltitude=j.observable();D.spnNTS250=j.observable();D.spnNTS50=j.observable();D.spnUTMzone=j.observable();D.spnUTMeast=j.observable();D.spnUTMnorth=j.observable();D.isLocDialogOpen=j.observable(false);D.urlNTS=l.getDict("%gisurlnts");D.urlUTM=l.getDict("%gisurlutm");D.urlAlti=l.getDict("%gisurlalti");D.outSR=k.getOutSR(o.mapwkid);D.activeTool=j.observable("");D.init=function(){var H;D.theAutoCompleteArray=j.observableArray(y);if(F.enable){B=e.setOverview(q,F);G.on("accordionactivate",function(J,K){var L,I;L=d(J.target.parentElement.getElementsByTagName("h3")[0]).hasClass("ui-state-active"),I=K.newPanel.hasClass("gcviz-tbnav-content");if(I&&L){B[0].startup();v.find("svg").attr("tabindex",-1).attr("focusable",false);G.off("accordionactivate");r.off("accordionactivate")}});r.on("accordionactivate",function(L){var J,M=d(L.target.getElementsByTagName("h3")[0]).hasClass("ui-state-active"),K=L.target.getElementsByTagName("h3"),I=K.length;if(M){while(I--){J=d(K[I]);if(J.hasClass("gcviz-nav-panel")&&J.hasClass("ui-state-active")){B[0].startup();v.find("svg").attr("tabindex",-1).attr("focusable",false);G.off("accordionactivate");r.off("accordionactivate")}}}})}if(u.enable){q.on("extent-change",function(){var I;H=Math.round(q.getScale()).toString();I=H.split("").reverse().join("");I=I.replace(/(\d{3})(?=\d)/g,"$1 ");I=I.split("").reverse().join("");D.lblScale(D.ScaleLabel+"1:"+I)})}return{controlsDescendantBindings:true}};D.endPosition=function(){E.removeClass("gcviz-nav-cursor-pos");i.addEvtPop();if(typeof t!=="undefined"){t.remove()}w.dialog("close");r.on("accordionactivate",function(){r.off("accordionactivate");setTimeout(function(){s.focus();D.activeTool("")},1000)});r.accordion("option","active",0)};x.focus(function(){x.val("")});x.autocomplete({source:function(I,H){var J=h.parseLonLat(I.term);if(typeof J!=="undefined"){J=[J[0]+";"+J[1]+";"+J[2]];H(d.map(J,function(U){var Q,O,T,P,R,M,S,N,K=U.split(";"),L=0.01799856;Q=parseFloat(K[1],10);O=parseFloat(K[0],10);R=Q-L;M=Q+L;S=O-L;N=O+L;T=h.convertDdToDms(O,Q,0);P=T.y.join().replace(/,/g,"")+" "+T.x.join().replace(/,/g,"");P+=" | "+Q.toFixed(3)+" "+O.toFixed(3);y.push({minx:S,miny:R,maxx:N,maxy:M,coords:K,title:P});return{label:P,value:P}}))}else{d.ajax({url:D.geoLocUrl,cache:false,dataType:"jsonp",data:{q:I.term+"*"},success:function(K){H(d.map(K,function(X){var P,R,T,S,U,N,W,O,L,Q,V=X.bbox,M=0.01799856;if(typeof V==="object"){R=X.geometry.coordinates;P=V;U=P[1];N=P[3];W=P[0];O=P[2]}else{P=X.geometry.coordinates;R=P;T=P[1];S=P[0];U=T-M;N=T+M;W=S-M;O=S+M}L=X.title;Q=X.title;y.push({minx:W,miny:U,maxx:O,maxy:N,coords:R,title:X.title});return{label:L,value:Q}}))}})}},minLength:3,select:function(J,L){var I,O,N,M,K;for(var H=0;H<y.length;H++){I=y[H],O=I.title;K=I.coords;if(L.item.label===O){M={polygon:[[[I.minx,I.miny],[I.maxx,I.miny],[I.maxx,I.maxy],[I.minx,I.maxy],[I.minx,I.miny]]]};k.zoomLocation(I.minx,I.miny,I.maxx,I.maxy,q,D.outSR);g.hideInfoWindow(q,"location");if(z.graphic){M={x:K[0],y:K[1]};c.createGraphic(q,"point",M,{title:O},4326,"location")}N=O;if(z.info){setTimeout(function(){g.showInfoWindow(q,"Location",N,"location",12,0)},1000)}}}y=[{minx:0,miny:0,maxx:0,maxy:0,title:"ddd"}];x.focus()},open:function(){d(this).removeClass("ui-corner-all").addClass("ui-corner-top")},close:function(){d(this).removeClass("ui-corner-top").addClass("ui-corner-all")},position:{collision:"fit",within:"#"+C}});D.getMapClick=function(){r.accordion("option","active",false);r.on("accordionbeforeactivate",function(){r.off();D.endPosition()});if(!D.isWCAG()){E.css("cursor","");E.addClass("gcviz-nav-cursor-pos");i.removeEvtPop();t=q.on("click",function(H){k.projectPoints([H.mapPoint],4326,D.displayInfo)})}else{D.isDialogWCAG(true)}D.activeTool("position");h.focusMap(q)};D.dialogWCAGOk=function(){var H=D.xValue()*-1,I=D.yValue();k.projectCoords([[H,I]],4326,D.displayInfo);D.isDialogWCAG(false);D.wcagok=true};D.dialogWCAGCancel=function(){D.isDialogWCAG(false)};D.dialogWCAGClose=function(){D.isDialogWCAG(false);if(!D.wcagok){D.isLocDialogOpen(false);r.accordion("option","active",0);D.endPosition()}};D.displayInfo=function(H){var M,K,L="",J=H[0].y,I=H[0].x;D.infoLatDD(" "+J);D.infoLongDD(" "+I);M=h.convertDdToDms(I,J,3);D.infoLatDMS(" "+M.y.join(" "));D.infoLongDMS(" "+M.x.join(" "));e.getNTS(J,I,D.urlNTS).done(function(O){var P,N=O.nts;if(N.length===2){P=N[0].properties;D.spnNTS250(P.identifier+" - "+P.name);P=N[1].properties;D.spnNTS50(P.identifier+" - "+P.name)}else{if(N.length===1){P=N[0].properties;D.spnNTS250(P.identifier+" - "+P.name);D.spnNTS50("")}else{D.spnNTS250("");D.spnNTS50("")}}});D.spnUTMeast("");D.spnUTMnorth("");e.getUTMzone(J,I,D.urlUTM).done(function(N){L=N.zone;D.spnUTMzone(L);k.getUTMEastNorth(J,I,h.padDigits(L,2),D.spnUTMeast,D.spnUTMnorth)});e.getAltitude(J,I,D.urlAlti).done(function(N){K="0";if(N.altitude!==null){K=N.altitude}D.spnAltitude(K+" m")});D.isLocDialogOpen(true)};D.dialogLocOk=function(){D.isLocDialogOpen(false);if(D.wcagok){r.accordion("option","active",0);D.endPosition();D.wcagok=false}};D.showOVMap=function(){if(D.isOVShowMap()){B[0].show();B[1].hide();A.removeClass("gcviz-ov-border")}else{if(!f){B[1].startup();f=true}B[1].show();B[0].hide();A.addClass("gcviz-ov-border")}return true};D.init()};a=new m(p,n);j.applyBindings(a,p[0]);return a};return{initialize:b}})}).call(this);