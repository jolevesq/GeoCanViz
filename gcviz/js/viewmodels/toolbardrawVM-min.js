(function(){define(["jquery-private","knockout","genfile","gcviz-i18n","gcviz-func","gcviz-gisgraphic","gcviz-gisdatagrid"],function(c,h,a,i,f,e,g){var d,b;d=function(m,j,l){var k=function(u,y){var z=this,A,w,v,q,r=i.getDict("%toolbardraw-dist"),x=i.getDict("%toolbardraw-area"),p=f.getElemValueVM(y,["map","map"],"js"),C=c("#"+y+"_holder_layers"),B=u.find(".gcviz-draw-line"),o=u.find(".gcviz-draw-text"),t=u.find(".gcviz-draw-length"),s=u.find(".gcviz-draw-area"),D=u.find(".gcviz-draw-delsel"),n=c("#gcviz-menu"+y);z.mapid=y;z.tpBlack=i.getDict("%toolbardraw-tpcolorblack");z.tpRed=i.getDict("%toolbardraw-tpcolorred");z.tpGreen=i.getDict("%toolbardraw-tpcolorgreen");z.tpBlue=i.getDict("%toolbardraw-tpcolorblue");z.tpYellow=i.getDict("%toolbardraw-tpcoloryellow");z.tpWhite=i.getDict("%toolbardraw-tpcolorwhite");z.tpDraw=i.getDict("%toolbardraw-tpdraw");z.tpText=i.getDict("%toolbardraw-tptext");z.tpMeasureArea=i.getDict("%toolbardraw-tpmeasurearea");z.tpMeasureLength=i.getDict("%toolbardraw-tpmeasurelength");z.tpErase=i.getDict("%toolbardraw-tperase");z.tpEraseSel=i.getDict("%toolbardraw-tperasesel");z.tpUndo=i.getDict("%toolbardraw-tpundo");z.tpRedo=i.getDict("%toolbardraw-tpredo");z.tpImport=i.getDict("%toolbardraw-tpimport");z.tpExport=i.getDict("%toolbardraw-tpexport");z.lblColor=i.getDict("%toolbardraw-lblselcolor");z.lblMeasFull=i.getDict("%toolbardraw-lblmeasfull");z.lblMeasLine=i.getDict("%toolbardraw-lblmeasline");z.lblMeasArea=i.getDict("%toolbardraw-lblmeasarea");z.lblDrawFull=i.getDict("%toolbardraw-lbldrawfull");z.lblDrawLine=i.getDict("%toolbardraw-lbldrawline");z.lblDrawText=i.getDict("%toolbardraw-lbldrawtext");z.lblErase=i.getDict("%toolbardraw-lblerase");z.lblUndoRedo=i.getDict("%toolbardraw-lblundoredo");z.lblImpExp=i.getDict("%toolbardraw-lblimpexp");z.lblTextTitle=i.getDict("%toolbardraw-inputbox-name");z.lblTextInfo=i.getDict("%toolbardraw-insinputbox");z.isTextDialogOpen=h.observable();z.isText=h.observable(false);z.drawTextValue=h.observable("");z.selectedColor=h.observable();z.stackUndo=h.observableArray([]);z.stackRedo=h.observableArray([]);z.isGraphics=h.observable(false);z.graphic=new e.initialize(p,z.isGraphics,z.stackUndo,z.stackRedo,r,x);z.measureHolder=h.observableArray([]);z.measureType="";z.activeTool=h.observable("");z.mapid=y;z.WCAGTitle=i.getDict("%wcag-title");z.lblWCAGx=i.getDict("%wcag-xlong");z.lblWCAGy=i.getDict("%wcag-ylat");z.lblWCAGmsgx=i.getDict("%wcag-msgx");z.lblWCAGmsgy=i.getDict("%wcag-msgy");z.lblWCAGadd=i.getDict("%wcag-addcoords");z.lblWCAGAddPoint=i.getDict("%wcag-add");z.xValue=h.observable().extend({numeric:{precision:3,validation:{min:50,max:130}}});z.yValue=h.observable().extend({numeric:{precision:3,validation:{min:40,max:80}}});z.WCAGcoords=h.observableArray([]);z.isWCAG=h.observable(false);z.isDialogWCAG=h.observable(false);z.wcagok=false;z.init=function(){z.selectColorClick("black");return{controlsDescendantBindings:true}};z.endDraw=function(){g.addEvtPop();if(!z.isWCAG()){z.removeCursors();C.css("cursor","default");if(z.measureType==="length"){w.remove();q.remove();z.endMeasureLength()}else{if(z.measureType==="area"){v.remove();q.remove();z.endMeasureArea()}}}z.graphic.deactivate();z.measureType="";z.setFocus();n.accordion("option","active",0)};z.dialogTextOk=function(){var E=z.drawTextValue();if(E!==""){if(!z.isWCAG()){z.graphic.drawText(E,z.selectedColor());z.drawTextValue("")}else{z.isDialogWCAG(true)}z.isText(true);z.isTextDialogOpen(false)}else{z.dialogTextCancel()}};z.dialogTextOkEnter=function(){z.dialogTextOk()};z.dialogTextCancel=function(){z.isTextDialogOpen(false);z.isText(false);z.endDraw()};z.dialogTextClose=function(){if(z.isTextDialogOpen()){z.isTextDialogOpen(false);z.isText(false);z.endDraw()}};z.selectColorClick=function(E){z.selectedColor(E)};z.drawClick=function(){z.closeTools("draw");if(!z.isWCAG()){C.css("cursor","");z.addDrawCursor(z.selectedColor());z.graphic.drawLine(z.selectedColor())}else{z.isDialogWCAG(true);z.enableOkWCAG("disable")}};z.textClick=function(){z.closeTools("text");if(!z.isWCAG()){C.css("cursor","");C.addClass("gcviz-text-cursor")}z.isText(false);z.drawTextValue("");z.isTextDialogOpen(true)};z.eraseClick=function(){z.graphic.erase();B.focus();c(".ui-tooltip").remove()};z.eraseSelClick=function(){z.closeTools("erase");C.css("cursor","");C.addClass("gcviz-draw-cursor-erase");z.graphic.drawExtent();f.focusMap(p)};z.undoClick=function(){z.graphic.undo();if(z.stackUndo().length===0){B.focus()}c(".ui-tooltip").remove()};z.redoClick=function(){z.graphic.redo();if(z.stackRedo().length===0){B.focus()}c(".ui-tooltip").remove()};z.measureLengthClick=function(){A=f.getUUID();z.closeTools("length");z.measureType="length";if(!z.isWCAG()){C.css("cursor","");C.addClass("gcviz-draw-cursor-measure");w=p.on("click",function(E){z.graphic.addMeasure(z.measureHolder,A,0,"km",z.selectedColor(),E)});q=p.on("dbl-click",function(E){z.graphic.addMeasure(z.measureHolder,A,0,"km",z.selectedColor(),E);setTimeout(function(){z.endMeasureLength()},250)})}else{z.isDialogWCAG(true);z.enableOkWCAG("disable")}f.focusMap(p)};z.endMeasureLength=function(){var E=z.measureHolder().length;if(E>=2){z.graphic.addMeasureSumLength(z.measureHolder,A,"km")}else{if(E>0){z.graphic.eraseUnfinish()}}z.measureHolder([]);A=f.getUUID()};z.measureAreaClick=function(){A=f.getUUID();z.closeTools("area");z.measureType="area";if(!z.isWCAG()){C.css("cursor","");C.addClass("gcviz-draw-cursor-measure");v=p.on("click",function(E){z.graphic.addMeasure(z.measureHolder,A,1,"km",z.selectedColor(),E)});q=p.on("dbl-click",function(E){z.graphic.addMeasure(z.measureHolder,A,1,"km",z.selectedColor(),E);z.endMeasureArea()})}else{z.isDialogWCAG(true);z.enableOkWCAG("disable")}f.focusMap(p)};z.endMeasureArea=function(){var E=z.measureHolder().length;if(E>=3){z.graphic.addMeasureSumArea(z.measureHolder,A,"km")}else{if(E>0){z.graphic.eraseUnfinish()}}z.measureHolder([]);A=f.getUUID()};z.launchDialog=function(){c(document.getElementById("fileDialogAnno"))[0].click()};z.importClick=function(H,J){var G,F,I=J.target.files,E=I.length;while(E--){G=I[E];F=new FileReader();F.onload=z.loadFile();F.readAsText(G)}document.getElementById("fileDialogAnno").value=""};z.loadFile=function(){return function(G){var E;try{E=JSON.parse(G.target.result);e.importGraphics(p,E,z.isGraphics)}catch(F){console.log("Not able to load graphics: "+F)}}};z.exportClick=function(){var E=e.exportGraphics(p);c.generateFile({filename:"graphics.json",content:E,script:l.urldownload})};z.closeTools=function(E){n.accordion("option","active",false);n.on("accordionbeforeactivate",function(){n.off();z.endDraw()});g.removeEvtPop();z.activeTool(E)};z.removeCursors=function(){C.removeClass("gcviz-draw-cursor-black gcviz-draw-cursor-blue gcviz-draw-cursor-green gcviz-draw-cursor-red gcviz-draw-cursor-yellow gcviz-draw-cursor-white gcviz-text-cursor gcviz-draw-cursor-measure gcviz-draw-cursor-erase")};z.addDrawCursor=function(E){if(E==="black"){C.addClass("gcviz-draw-cursor-black")}else{if(E==="blue"){C.addClass("gcviz-draw-cursor-blue")}else{if(E==="green"){C.addClass("gcviz-draw-cursor-green")}else{if(E==="red"){C.addClass("gcviz-draw-cursor-red")}else{if(E==="yellow"){C.addClass("gcviz-draw-cursor-yellow")}else{if(E==="white"){C.addClass("gcviz-draw-cursor-white")}}}}}}};z.setFocus=function(){n.on("accordionactivate",function(){n.off("accordionactivate");setTimeout(function(){if(z.activeTool()==="draw"){B.focus()}else{if(z.activeTool()==="text"){o.focus()}else{if(z.activeTool()==="length"){t.focus()}else{if(z.activeTool()==="area"){s.focus()}else{if(z.activeTool()==="erase"){if(z.isGraphics()){D.focus()}else{B.focus()}}}}}}z.activeTool("")},1000)})};z.dialogWCAGOk=function(){var E=false;if(z.activeTool()==="draw"){z.graphic.drawLineWCAG(z.WCAGcoords(),z.selectedColor());E=true}else{if(z.activeTool()==="text"){z.graphic.drawTextWCAG([z.xValue()*-1,z.yValue()],z.drawTextValue(),z.selectedColor());z.drawTextValue("");E=true}else{if(z.activeTool()==="length"){z.graphic.measureWCAG(z.WCAGcoords(),A,0,"km",z.selectedColor());E=true}else{if(z.activeTool()==="area"){z.graphic.measureWCAG(z.WCAGcoords(),A,1,"km",z.selectedColor());E=true}}}}if(E){z.isDialogWCAG(false);z.wcagok=true}};z.dialogWCAGCancel=function(){z.isDialogWCAG(false)};z.dialogWCAGClose=function(){var E=z.activeTool();z.isDialogWCAG(false);if(E!=="text"||(!z.wcagok&&E==="text")){z.endDraw()}z.wcagok=false;z.WCAGcoords([])};z.enableOkWCAG=function(E){c("#diagDrawWCAG"+y).parent().find("#btnOk").button(E)};z.addCoords=function(){var E=z.xValue()*-1,G=z.yValue(),F=z.WCAGcoords()[z.WCAGcoords().length-1];if(typeof F==="undefined"){z.WCAGcoords.push([E,G])}else{if(E!==F[0]||G!==F[1]){z.WCAGcoords.push([E,G])}}if(z.activeTool()!=="area"&&z.WCAGcoords().length>1){z.enableOkWCAG("enable")}else{if(z.WCAGcoords().length>2){z.enableOkWCAG("enable")}}};z.init()};b=new k(m,j);h.applyBindings(b,m[0]);return b};return{initialize:d}})}).call(this);