(function(){define(["jquery-private","knockout","gcviz-i18n","gcviz-func","gcviz-gismap","gcviz-gisdatagrid"],function(d,j,k,h,g,i){var e,b,c,f,a;e=function(o,m,n){var l=function(H,v,G){var q=this,F=400,p=0,y=null,E=[],x=[],D=0,w=G.layers.length,C=[],t=[],u=0,s=0,r=h.getElemValueVM(v,["map","map"],"js"),B=d("#gcviz-datagrid"+v),A=d("#gcviz-datatab"+v),z=A.find("ul"),I=d("#gcviz-popup-content"+v);q.processing=k.getDict("%datagrid-processing");q.search=k.getDict("%datagrid-search");q.lengthMenu=k.getDict("%datagrid-lengthMenu");q.info=k.getDict("%datagrid-info");q.infoEmpty=k.getDict("%datagrid-infoEmpty");q.infoFiltered=k.getDict("%datagrid-infoFiltered");q.infoThousands=k.getDict("%datagrid-infoThousands");q.infoPostFix=k.getDict("%datagrid-infoPostFix");q.loadingRecords=k.getDict("%datagrid-loadingRecords");q.zeroRecords=k.getDict("%datagrid-zeroRecords");q.emptyTable=k.getDict("%datagrid-emptyTable");q.first=k.getDict("%datagrid-first");q.previous=k.getDict("%datagrid-previous");q.next=k.getDict("%datagrid-next");q.last=k.getDict("%datagrid-last");q.sortAscending=k.getDict("%datagrid-sortAscending");q.sortDescending=k.getDict("%datagrid-sortDescending");q.lblAllLayer=k.getDict("%datagrid-popalllayers");q.lblSelectLayer=k.getDict("%datagrid-popselect");q.lblSelectAll=k.getDict("%datagrid-selectall");q.lblZoomSelect=k.getDict("%datagrid-zoomselect");q.popupDialogTitle=k.getDict("%datagrid-poptitle");q.layerNameHolder=j.observableArray([]);q.layerName=j.observableArray([q.lblAllLayer]);q.featLayerName=j.observable("");q.selectedLayer=j.observable(0);q.isPopupDialogOpen=j.observable(false);q.isEnablePrevious=j.observable(false);q.isEnableNext=j.observable(false);q.popupCounter=j.observable("");q.init=function(){d("#gcviz-datagrid"+v).accordion({collapsible:true,active:false,activate:function(){E[0].order([3,"asc"]).draw()}});d(".ui-accordion-header").hide();r.on("load",function(){var K=G.layers,J=K.length;i.initialize(r);while(J--){q.getData(K[J])}})};q.getData=function(M){var P,O=M.layerinfo,L=O.index,N=O.type,K=r.getLayer(O.id).url,J=M.popups.enable;if(N===4){P=K+L+"/query?where=OBJECTID+>+0&outFields=*&dirty="+(new Date()).getTime();i.getData(P,M,q.createTab);if(J){i.createIdTask(K,L,q.returnIdTask)}}else{if(N===5){P=K+"/query?where=OBJECTID+>+0&outFields=*&dirty="+(new Date()).getTime();i.getData(P,M,q.createTab);if(J){K=K.substring(0,K.indexOf("MapServer/")+10);i.createIdTask(K,L,q.returnIdTask)}}}};q.createTab=function(K){var J=K[0].layer,L=J.mapid;delete K[0].layer;D+=1;z.append('<li><a href="#tabs-'+L+"-"+D+'">'+J.title+"</a></li>");A.append('<div id="tabs-'+L+"-"+D+'" class="gcviz-datagrid-tab"><table id="table-'+L+"-"+D+'" class="gcviz-datatable display"><button class="gcviz-dg-zoomsel">'+q.lblZoomSelect+'</button><input type="checkbox" class="gcviz-dg-selall" id="cb_seletAllFeat"><label for="cb_seletAllFeat" class="form-checkbox gcviz-dg-lblselall">'+q.lblSelectAll+"</label></table></div>");q.createTable(K,J)};q.createTable=function(N,M){var L,K=d("#table-"+v+"-"+D),J=q.createFields(M);L=K.DataTable({data:N,scrollY:300,scrollX:true,scrollCollapse:true,pagingType:"full",processing:true,columns:J,initComplete:function(){q.finishInit(D)},language:{processing:q.processing,search:q.search,lengthMenu:q.lengthMenu,info:q.info,infoEmpty:q.infoEmpty,infoFiltered:q.infoFiltered,infoThousands:q.infoThousands,infoPostFix:q.infoPostFix,loadingRecords:q.loadingRecords,zeroRecords:q.zeroRecords,emptyTable:q.emptyTable,paginate:{first:q.first,previous:q.previous,next:q.next,last:q.last},aria:{sortAscending:q.sortAscending,sortDescending:q.sortDescending}}});K.on("draw.dt",function(O){q.selectAll(O,"page")});L.order([3,"asc"]).draw();E.push(L);x.push(N.reverse())};q.createFields=function(K){var L,J=K.fields,M=J.length;while(M--){L=J[M];L.render=function(O,N){if(O!==null){return N==="display"&&O.length>40?'<span title="'+O+'">'+O.substr(0,38)+"...</span>":O}else{return O}}}J.unshift({data:null,className:"dt-body-center",title:"Zoom",width:"35px",searchable:false,orderable:false,render:function(O,N){if(N==="display"){return'<button class="gcviz-dg-zoom">Zoom</button>'}return O}});J.unshift({data:null,className:"dt-body-center",title:"Select",width:"28px",searchable:false,orderable:false,render:function(O,N){if(N==="display"){return'<input type="checkbox" class="gcviz-dg-select">'}return O}});J.unshift({data:"gcvizid",className:"gcviz-dg-id",title:"id",searchable:false,orderable:false});return J};q.finishInit=function(){q.setEvents();if(D===w){A.tabs({heightStyle:"auto",activate:function(){var J=E.length;while(J--){E[J].order([3,"asc"]).draw()}}});B.accordion("refresh");h.setElemValueVM(v,"footer","isTableReady",true)}if(D>w){A.tabs("refresh");B.accordion("refresh")}};q.setEvents=function(){var K=d("#table-"+v+"-"+D),J=d("#tabs-"+v+"-"+D);K.on("change","input.gcviz-dg-select",function(N){var L=d(N.target.parentNode.parentNode).find(".gcviz-dg-select"),M=q.getInfo(N,"control");q.select(L,M)});J.on("change","input.gcviz-dg-selall",function(L){q.selectAll(L,"checkbox")});K.on("click","button.gcviz-dg-zoom",function(M){var L=q.getInfo(M,"control");q.zoom(L)});J.on("click","button.gcviz-dg-zoomsel",function(L){q.zoomSelect(L)});K.on("click",function(N){var M,L=N.target.type;if(L!=="checkbox"&&L!=="submit"){p++;if(p===1){y=setTimeout(function(){var O=d(N.target.parentNode).find(".gcviz-dg-select");M=q.getInfo(N,"row");if(O.prop("checked")){O.prop("checked",false)}else{O.prop("checked",true)}q.select(O,M);p=0},F)}else{clearTimeout(y);M=q.getInfo(N,"row");q.zoom(M);p=0}}}).on("dblclick",function(L){L.preventDefault()})};q.getInfo=function(M,K){var J,N,L;if(K==="row"){N=d(M.target.parentNode).find(".gcviz-dg-id").html()}else{N=d(M.target.parentNode.parentNode).find(".gcviz-dg-id").html()}L=N.split("-");J={table:parseInt(L[0],10),feat:parseInt(L[1],10)};return J};q.zoom=function(K){var J;J=x[K.table][K.feat].geometry;i.zoomFeature(J)};q.zoomSelect=function(O){var L,K=[],M=parseInt(O.target.parentElement.id.split("-")[2],10)-1,N=x[M],J=N.length;while(J--){L=N[J];if(L.gcvizCheck){K.push(L.geometry)}}if(K.length>0){i.zoomFeatures(K)}};q.select=function(L,M){var J,K=x[M.table][M.feat];if(L.prop("checked")){K.gcvizCheck=true;J=K.geometry;i.selectFeature(J,M)}else{K.gcvizCheck=false;i.unselectFeature("sel"+M.table+"-"+M.feat)}};q.selectAll=function(O,Q){var L,S,J,R,K={},P=O.target,M=P.parentElement.getElementsByClassName("gcviz-dg-select"),N=M.length;if(Q==="page"){J=P.parentElement.parentElement.parentElement.parentElement.getElementsByClassName("gcviz-dg-selall")[0].checked}else{J=P.checked;L=parseInt(P.parentElement.id.split("-")[2]-1,10);K.table=L}while(N--){if(J){M[N].checked=J}else{M[N].checked=J}}if(Q==="checkbox"){S=x[L],R=S.length;while(R--){if(J){K.feat=[R];S[R].gcvizCheck=true;i.selectFeature(S[R].geometry,K)}else{S[R].gcvizCheck=false;i.unselectFeature("sel"+L+"-"+R)}}}};c=q.createTab;f=D;q.returnIdTask=function(O){var M,L,J,K=false,N=O.length;t=[];q.layerNameHolder([]);q.layerNameHolder.push(q.lblAllLayer);while(N--){M=O[N][1];J=M.length;if(J>0){K=true;while(J--){L=M[J];t.push(L);q.layerNameHolder.push(L.layerName)}}}if(K){q.layerName(j.utils.arrayGetDistinctValues(q.layerNameHolder()));q.changeSelectLayer()}};q.displayFeature=function(J){var K,N,W,T,R,U,Q,P=J.layerName,V=J.feature,M=V.attributes,O=G.layers,S=O.length;while(S--){Q=O[S];if(Q.popups&&P===Q.popups.title){N=d.map(M,function(Y,X){return[X]});W=d.map(M,function(X){return[X]});q.featLayerName(P);K="";R=Q.fields;U=R.length-1;while(U>2){T=R[U];U--;for(var L=0;L<N.length;L++){if(T.datapop.toUpperCase()===N[L].toUpperCase()){K='<span class="gcviz-prop">'+T.title+'</span><p class="gcviz-val">'+W[L]+"</p>"+K}}}I.html(K)}}i.selectFeaturePop(V.geometry)};q.dialogPopupClose=function(){q.isPopupDialogOpen(false);i.unselectFeature("popup")};q.changeSelectLayer=function(){var L,M=q.lblAllLayer,K=q.selectedLayer(),J=t.length;i.unselectFeature("popup");C=[];if(K!==M){while(J--){L=t[J];if(L.layerName===K){C.push(L)}}}else{C=t}s=C.length;if(s===0){q.selectedLayer(M);C=t}u=0;q.displayFeature(C[0]);q.isPopupDialogOpen(true);q.popupCounter("1 / "+s);q.isEnablePrevious(false);if(s>1){q.isEnableNext(true)}};q.clickZoom=function(){var J=C[u].feature;g.zoomFeature(r,J)};q.clickPrevious=function(){var K,J;if(u>0){u--;K=C[u];q.displayFeature(K);J=(u===0)?false:true;q.isEnablePrevious(J);q.isEnableNext(true);q.popupCounter((u+1)+" / "+s);i.unselectFeature("popup");i.selectFeaturePop(K.feature.geometry)}};q.clickNext=function(){var K,J;if(u<=(s-1)){u++;K=C[u];q.displayFeature(K);J=(u===(s-1))?false:true;q.isEnablePrevious(true);q.isEnableNext(J);q.popupCounter((u+1)+" / "+s);i.unselectFeature("popup");i.selectFeaturePop(K.feature.geometry)}};q.init()};a=new l(o,m,n);j.applyBindings(a,o[0]);return a};b=function(w,p,x,m){var y,u,o={},t=[],q=[],n=p.layerDefinition.fields,v=n.length,s={},r=p.featureSet.features,l=r.length,z=f+1;while(v--){y=n[v];delete y.type;delete y.render;delete y.editable;delete y.domain;y.title=y.alias;delete y.alias;y.data=y.name;delete y.name;t.push(y)}while(l--){u=r[l];o=u.attributes;o.geometry=u.geometry;o.layerid=m;o.gcvizid=z+"-"+l;q.push(o)}s.title=x;s.mapid=w;s.fields=t;q[0].layer=s;c(q)};return{initialize:e,addTab:b}})}).call(this);