(function(){define(["jquery-private","knockout","gcviz-func","gcviz-gissymbol","gcviz-gisgeo","esri/layers/GraphicsLayer","esri/toolbars/draw","esri/symbols/SimpleLineSymbol","esri/geometry/ScreenPoint","esri/geometry/Point","esri/geometry/Polygon","esri/geometry/Polyline","esri/graphic","dojo/on"],function(s,a,v,q,n,k,e,u,d,f,r,g,j,m){var b,t,i,c,h,l,p,o;b=function(z,B,x,y,A,w){require(["gcviz-gissymbol"],function(D){o=D});var C=function(T,E,ab,Q,O,ah){var K=this,I,ag,W,ap,ao,ar,ad,ak,J,M,aq,ae,P,U,R,L,V,S,aa,an,F,X=ab,N=Q,ac=T,G=ac.vWkid,Z=O,at=ah,al=[0,0,0,255],ai=[229,0,51,255],aj=[0,140,0,255],Y=[0,77,255,255],H=[255,217,51,255],D=[255,255,255,255],am=[205,197,197,100],af=false;K.init=function(){T.addLayer(new k({id:"gcviz-symbol"}));I=ac.getLayer("gcviz-symbol");R=new e(ac,{showTooltips:false});m(R,"DrawEnd",P)};K.deactivate=function(){R.deactivate()};K.drawLine=function(au){U(au);R.setLineSymbol(o.getSymbLine(V,2));R.activate(e.FREEHAND_POLYLINE)};K.drawLineWCAG=function(av,au){U(au);n.projectCoords(av,ac.spatialReference.wkid,P)};K.drawText=function(av,au){L=av;U(au);R.activate(e.POINT)};K.drawTextWCAG=function(au,aw,av){L=aw;U(av);n.projectCoords([[au[0],au[1]]],ac.spatialReference.wkid,P)};K.drawExtent=function(){R.setFillSymbol(o.getSymbErase());R.activate(e.EXTENT)};K.erase=function(){var av=[],aw=I.graphics,au=I.graphics.length;while(au--){av.push(aw[au])}if(av.length>0){X.push({task:"delete",geom:av})}I.clear();ac.graphics.clear();E(false)};K.eraseSelect=function(az){var aA,aw,ay=[],au=[],av=I.graphics,ax=I.graphics.length;while(ax--){aA=av[ax];if(az.intersects(aA.geometry)){ay.push(aA.key)}}aw=ay.length;while(aw--){ax=av.length;while(ax--){aA=av[ax];if(ay[aw]===aA.key){I.remove(aA);au.push(aA)}}}if(au.length>0){X.push({task:"delete",geom:au})}if(I.graphics.length===0){E(false)}else{if(I.graphics.length===1&&I.graphics[0]._extent.xmax===0){E(false)}}};K.eraseUnfinish=function(){var aw=I.graphics,au=aw.length,ax=aw[au-1].key,av=ax;while(au--&&ax===av){I.remove(aw[au]);if(au>0){av=aw[au-1].key}}J.remove();T.graphics.clear()};K.undo=function(){var av=X.pop(),aw=av.geom,au=aw.length;if(av.task==="delete"){while(au--){I.add(aw[au])}}else{while(au--){I.remove(aw[au])}}N.push(av);if(I.graphics.length===0){E(false)}else{if(I.graphics.length===1&&I.graphics[0]._extent.xmax===0){E(false)}else{E(true)}}};K.redo=function(){var av=N.pop(),aw=av.geom,au=aw.length;if(av.task==="delete"){while(au--){I.remove(aw[au])}}else{while(au--){I.add(aw[au])}}X.push(av);if(I.graphics.length===0){E(false)}else{if(I.graphics.length===1&&I.graphics[0]._extent.xmax===0){E(false)}else{E(true)}}};K.measureWCAG=function(ax,av,aw,ay,au){S=av;aa=ay;U(au);af=true;if(aw===0){n.projectCoords(ax,ac.spatialReference.wkid,ag)}else{n.projectCoords(ax,ac.spatialReference.wkid,W)}};ag=function(ay){var ax,aw=[],av=0,au=ay.length-1;while(av<au){aw[0]=ay[av];aw[1]=ay[av+1];av+=1;n.measureLength(aw,aa,ap);aw=[]}ax=a.observableArray(ay.reverse());setTimeout(function(){K.addMeasureSumLength(ax,S,aa)},2000)};W=function(av){var au;au=a.observableArray(av.reverse());ao(au);setTimeout(function(){K.addMeasureSumArea(au,S,aa)},2000)};K.addMeasure=function(ax,aE,az,aB,au,aC){var aw,av,ay=false,aD=aC.screenPoint,aA=ac.toMap(new d(aD.x,aD.y));S=aE;U(au);aw=ax().length;if(aw>=1){av=ax()[aw-1];if(av.x===aA.x&&av.y===aA.y){ay=true}}if(!ay){ax().push(aA);if(az===0){if(aw===0){ap(ax());J=T.on("mouse-move",v.debounce(function(aF){var aG=aF.screenPoint,aH=ac.toMap(new d(aG.x,aG.y));M(aH,aB)},50,false))}else{n.measureLength(ax(),aB,ap)}}else{if(az===1){ao(ax)}}}};K.addMeasureSumLength=function(az,aE,aB){var aG,aF,ax,aw,aA=0,ay=az().length,aD=az()[ay-1],aC=az()[ay-2],av=(Math.atan2((aD.y-aC.y),(aD.x-aC.x))*(180/Math.PI)),au=Math.round(av/90);S=aE;while(ay--){aG=az()[ay];if(aG.hasOwnProperty("distance")){aA+=aG.distance}}if(au===0){ax=20;aw=10}else{if(au===1){ax=0;aw=10}else{if(au===-1){ax=0;aw=-20}else{ax=-20;aw=10}}}aA=Math.floor(aA*100)/100;aF=Z+aA+" "+aB;aD.text=aF;ak(aD,0,ax,aw);l(S);if(!af){J.remove()}else{af=false}T.graphics.clear()};K.addMeasureSumArea=function(ay,aA,az){var aC,av,au,aw=[],ax=ay().length,aB=ax-1;S=aA;while(ax--){aC=ay()[ax];aw.push([aC.x,aC.y])}aC=ay()[aB];aw.push([aC.x,aC.y]);av={rings:[aw],spatialReference:{wkid:G}};au=new r(av);n.measureArea(au,az,ar);af=false};ar=function(aw,au,av){var ax={};ax.area=Math.floor(au.areas[0]*100)/100;ax.length=Math.floor(au.lengths[0]*100)/100;ax.unit=av;n.labelPoints(aw,ax,ad)};ad=function(au,aw){var av=au[0],ax={geometry:{x:av.x,y:av.y,spatialReference:{wkid:G}}};ax.text=at+aw.area+" "+aw.unit+"2";ak(ax,0,0,0);l(S)};ap=function(az,aB){var aE,aC,aA,aD,av,au,ax=0,aw=-15,ay=az.length;if(ay>1){aC=az[ay-1];aA=az[ay-2];aE={geometry:{paths:[[[aC.x,aC.y],[aA.x,aA.y]]],spatialReference:{wkid:G}}};C=new j(aE);C.symbol=o.getSymbLine(V,1);C.key=S;I.add(C);aD={geometry:{x:(aC.x+aA.x)/2,y:(aC.y+aA.y)/2,spatialReference:{wkid:G}}};aD.text=aC.distance+" "+aB;av=(Math.atan2((aC.y-aA.y),(aC.x-aA.x))*(180/Math.PI));if(av>90||av<-90){av-=180}au=Math.round(Math.abs(av)/90);if(au===1){ax=15;aw=0}else{if(au===3){ax=-15;aw=0}}ak(aD,av,ax,aw)}C=new j(az[ay-1]);C.symbol=o.getSymbPoint(V,4,am,2);C.key=S;I.add(C);T.graphics.clear()};M=function(aA,ay){var ax=ac.spatialReference,aw=I.graphics,au=aw.length,az=aw[au-1].geometry,av={geometry:{paths:[[[az.x,az.y],[aA.x,aA.y]]],spatialReference:{wkid:G}}};T.graphics.clear();C=new j(av);C.symbol=o.getSymbLine(V,1);T.graphics.add(C);n.measureLength([new f(az.x,az.y,ax),new f(aA.x,aA.y,ax)],ay,aq)};aq=function(az,au){var av,ay,aw=az[1],ax=aw.distance;if(ax>0){ay=new j(aw,av);ay.symbol=o.getSymbText(V,aw.distance+" "+au,10,0,0,-10,"normal","center");ae(ay,an,"center",12,0,-2,-11,T.graphics);T.graphics.add(ay)}};ao=function(aA){var ax,az,aw=[],au=aA().length,av=au,ay=au-1;C=new j(aA()[au-1]);C.symbol=o.getSymbPoint(V,4,am,2);C.key=S;I.add(C);if(au>1){while(av--){ax=aA()[av];aw.push([ax.x,ax.y])}ax=aA()[ay];aw.push([ax.x,ax.y]);az={geometry:{rings:[aw],spatialReference:{wkid:G}}};if(au>2){I.remove(I.graphics[I.graphics.length-2])}C=new j(az);C.symbol=o.getSymbPoly(V,am,1);C.key=S;I.add(C)}};ak=function(ax,ay,av,au){var az,aw;az=new j(ax,aw);az.symbol=o.getSymbText(V,ax.text,10,ay,av,au,"normal","center");az.key=S;ae(az,an,"center",12,ay,av,au-2,I);I.add(az);E(true)};ae=function(aH,aA,az,aI,aw,aG,aE,ax){var au,aD,aB,ay,aF="",av=aH.symbol,aC=aH.geometry;aD={geometry:{x:aC.x,y:aC.y,spatialReference:{wkid:G}}};aB=v.getTextWidth(av.text,av.font);ay=Math.ceil(aB/8);if(ay<5){ay+=1}while(ay--){aF+="\u2588"}au=new j(aD);au.symbol=o.getSymbText(aA,aF,aI,aw,aG,aE,"bold",az);au.key=S;ax.add(au)},P=function(av){var ay,ax,au,aw=new u();if(av.length===undefined){ax=av}else{if(av.length===1){ax=av[0]}else{ax=new g(av[0].spatialReference);ax.addPath(av)}}au=ax.type;S=v.getUUID();if(au==="extent"){K.eraseSelect(ax)}else{if(au==="polyline"){aw=o.getSymbLine(V,2);ay=new j(ax,aw);v.focusMap(T)}else{if(au==="point"){aw=o.getSymbText(V,L,10,0,0,0,"normal","left");ay=new j(ax,aw);ae(ay,an,"left",12,0,-4,-1,I);K.deactivate();setTimeout(function(){v.getElemValueVM(ac.vIdName,["draw","isTextDialogOpen"],"js")(true)},1000);setTimeout(function(){R.activate(e.POINT)},1500)}}ay.key=S;I.add(ay);E(true);l(S)}};l=function(ax){var ay,av=[],aw=I.graphics,au=I.graphics.length;while(au--){ay=aw[au];if(ay.key===ax){av.push(ay)}}X.push({task:"add",geom:av})};U=function(au){if(au==="red"){V=ai;an=D}else{if(au==="green"){V=aj;an=D}else{if(au==="blue"){V=Y;an=D}else{if(au==="yellow"){V=H;an=al}else{if(au==="white"){V=D;an=al}else{V=al;an=D}}}}}F=au};K.init()};return new C(z,B,x,y,A,w)};t=function(B,x,C){var A,D,z=v.getUUID(),y=B.getLayer("gcviz-symbol"),w=x.length;if(w>0){C(true)}while(w--){A=x[w];D=new j(A);D.key=z;y.add(D)}l(z)};i=function(A){var z,B,y=[],x=A.getLayer("gcviz-symbol").graphics,w=x.length;while(w--){B=x[w];z=B.toJson();z.key=B.key;y.push(z)}return JSON.stringify(y)};c=function(B,A,y,w,z,x){var C;if(A==="point"){C=new f({x:y.x,y:y.y,spatialReference:z})}else{if(A==="polyline"){C=new g({paths:y.paths,spatialReference:z})}else{if(A==="polygon"){C=new r({rings:y.polygon,spatialReference:z})}}}p=B;w.key=x;C.attributes={},C.attributes.attributes=w;n.projectGeoms([C],B.spatialReference.wkid,h)};h=function(A){var y,C,z=A[0],B=z.geometry,x=B.type,w=p.getLayer("gcviz-symbol");if(x==="point"){y=o.getSymbPoint([205,197,197,180],20,[229,0,51,255],2)}else{if(x==="polyline"){y=o.getSymbLine([229,0,51,255],2)}else{if(x==="polygon"){y=o.getSymbPoly([205,197,197,100],[229,0,51,255],2)}}}C=new j(B);C.symbol=y;C.key=z.attributes.key;w.add(C);p=""};return{initialize:b,importGraphics:t,exportGraphics:i,createGraphic:c}})}());