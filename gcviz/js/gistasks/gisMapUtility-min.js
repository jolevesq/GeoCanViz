(function(){define(["jquery-private","kineticpanning","gcviz-func","dijit/Menu","dijit/MenuItem","dijit/PopupMenuItem","gcviz-gislegend","gcviz-giscluster","esri/config","esri/map","esri/layers/FeatureLayer","esri/layers/ArcGISTiledMapServiceLayer","esri/layers/ArcGISDynamicMapServiceLayer","esri/layers/ArcGISImageServiceLayer","esri/layers/WebTiledLayer","esri/layers/WMSLayer","esri/layers/WMSLayerInfo","esri/geometry/Extent","esri/geometry/Point","esri/IdentityManager"],function(E,f,u,W,Y,G,I,H,p,P,K,d,l,r,N,A,T,g,V){var B={},O,t,J,a,b,X,k,o,s,j,S,F,M,U,Q,D,v,i,C,q,n,e,Z,x,c,z=[],R,y,L={},h,m,w=false;O=function(aa){p.defaults.io.proxyUrl=aa;p.defaults.io.alwaysUseProxy=false};t=function(ad,af,am){var ai,ab,ac=af.extentinit,aj=af.extentmax,ah=af.sr.wkid,ao=new g({xmin:ac.xmin,ymin:ac.ymin,xmax:ac.xmax,ymax:ac.ymax,spatialReference:{wkid:ah}}),ap=new g({xmin:aj.xmin,ymin:aj.ymin,xmax:aj.xmax,ymax:aj.ymax,spatialReference:{wkid:ah}}),ak=af.lods.values.reverse(),al=ak.length,ae=[],aq,aa,an=ad.split("_")[0],ag;while(al--){ai=ak[al];if(ai.check){ae.push(ai)}}if(ae.length){aq={extent:ao,spatialReference:{wkid:ah},logo:false,showAttribution:false,lods:ae,wrapAround180:true,smartNavigation:false};if(af.zoombar.bar){aq.slider=true;aq.sliderPosition=am===1?"top-left":"top-right";aq.sliderStyle="large"}}else{aq={extent:ao,spatialReference:{wkid:ah},logo:false,showAttribution:false,wrapAround180:true,smartNavigation:false}}aa=new P(ad,aq);B[an]=aa;ag=new f(aa);ag.enableMouse();aa.vInitExtent=ao;aa.vFullExtent=ap;aa.vIdName=an;aa.vWkid=ah;aa.vInsetId=[];aa.vSideMenu=am;aa.on("load",function(){aa.resize();aa.enableScrollWheelZoom();aa.disableDoubleClickZoom();aa.disableKeyboardNavigation();E(".gcviz-section").find("svg").attr("tabindex",-1).attr("focusable",false);if(af.link){z.push({name:aa.vIdName,fire:false});X(aa)}else{k(aa)}m=z.length});ab=aa.on("update-end",function(){u.destroyProgressBar();ab.remove()});return aa};J=function(ah,aa,ab){var ag=aa.extent,ae=aa.sr.wkid,ad=new g({xmin:ag.xmin,ymin:ag.ymin,xmax:ag.xmax,ymax:ag.ymax,spatialReference:{wkid:ae}}),af,ac;af=new P(ah,{extent:ad,spatialReference:{wkid:ae},logo:false,showAttribution:false,smartNavigation:false});ac=new f(af);ac.enableMouse();af.vWkid=ae;af.vType=aa.type;af.on("load",function(){af.resize();af.disableMapNavigation();if(aa.type!=="static"){B[ab].vInsetId.push(af.id);L[ah]=af;if(aa.typeinfo.pan){af.enablePan()}if(aa.type==="panscale"){af.vLod=aa.typeinfo.lod;af.setLevel(af.vLod);setTimeout(function(){af.vDeltaX=(Math.abs(af.extent.xmax)-Math.abs(af.extent.xmin))/2;af.vDeltaY=(Math.abs(af.extent.ymax)-Math.abs(af.extent.ymin))/2},1000)}}});return af};a=function(ad){var aa=z.length,ac,ae,ab;while(aa--){ae=z[aa];ac=ae.name;if(ac!==ad){ab=B[ac];ab.setExtent(B[ad].extent,ab.spatialReference)}}};y=function(ac){var aa=ac.vInsetId.length,ab;while(aa--){ab=L[ac.vInsetId[aa]];if(ab.vType==="panscale"){b(ac,ab)}else{if(ab.vType==="link"){ab.setExtent(ac.extent)}}}};b=function(ad,aa){var ac=U(ad),ab=new g({xmin:ac.x-aa.vDeltaX,ymin:ac.y-aa.vDeltaY,xmax:ac.x+aa.vDeltaX,ymax:ac.y+aa.vDeltaY,spatialReference:{wkid:ad.spatialReference.wkid}});aa.setExtent(ab)};X=function(aa){aa.on("extent-change",u.debounce(function(ac){var ad=ac.target,ae=ad.id.split("_")[0],ab=false;if(m===z.length){ab=true}if(ab&&!h){setTimeout(function(){a(ae)},1000)}if(!w){y(ad)}w=false;m-=1;if(m===0){setTimeout(function(){m=z.length},1000)}},1000,false))};k=function(aa){aa.on("extent-change",u.debounce(function(ab){var ac=ab.target;if(!w){y(ac)}w=false},1000,false))};o=function(ae,ad){var ab,aa,af,ac=ad.type;if(ac===1){}else{if(ac===2){ab=new d(ad.url,{id:ad.id})}else{if(ac===3){aa=ad.options;af={extent:ae.extent,layerInfos:aa.layerinfos};ab=new A(ad.url,{resourceInfo:af,visibleLayers:aa.visiblelayers,id:ad.id})}else{if(ac===4){ab=new l(ad.url,{id:ad.id})}else{if(ac===5){ab=new K(ad.url,{mode:K.MODE_ONDEMAND,outFields:["*"],id:ad.id})}else{if(ac===6){H.startCluster(ae,ad)}}}}}}if(ac!==6){ae.addLayer(ab);s(ae,ad)}};s=function(ab,aa){var ad,ac=aa.scale;ad=ab.getLayer(aa.id);ad.myMap=ab;ad.on("load",function(){var ah,af=ac.min,ae=ac.max,ag=ad.myMap.getScale();ad.minScale=af;ad.maxScale=ae;delete ad.myMap;if(af!==0&&ae!==0){if(af>ag&&ag<ae){ah=E("#"+aa.id);ah.addClass("gcviz-leg-dis")}}});ad.on("scale-visibility-change",function(){var ae=E("#"+aa.id);if(ad.visibleAtMapScale){ae.removeClass("gcviz-leg-dis")}else{ae.addClass("gcviz-leg-dis")}})};c=function(ac,aa){var ab;if(ac===1){ab=new N(aa)}else{if(ac===2){ab=new d(aa)}else{if(ac===4){ab=new l(aa)}}}return ab};j=function(aa){aa.resize()};S=function(ad,ac){var aa,ab;ac=ac||{};aa=ac.point||U(ad);ab=ac.interval||0;j(ad);setTimeout(function(){F(ad,aa)},ab)};F=function(ab,aa){aa=aa||U(ab);ab.centerAt(aa)};M=function(ag,ad){var af,ah,aa,ac=ad.geometry,ae=ac.type,ab=0.25;if(ae==="point"){ah=ag._params.lods,aa=ah.length;if(aa>0){ab=ah[aa-1].level}af=new V(ac.x,ac.y,ag.vWkid);ag.centerAndZoom(af,ab)}else{ag.setExtent(ac.getExtent().expand(1.5))}};U=function(ac){var ab,aa;ab=ac.extent;aa=new V((ab.xmin+ab.xmax)/2,(ab.ymin+ab.ymax)/2,ac.vWkid);return aa};R=function(ad,aa,ac){var ab=ad.extent;h=ac;if(ac){w=true}j(ad);setTimeout(function(){ad.setExtent(ab)},aa)};Q=function(){var aa=new W({targetNodeIds:["gcviz-header"]});aa.addChild(new Y({label:"Add Point",onClick:function(){}}));aa.startup()};D=function(aa){aa.setExtent(x(aa,"in"))};v=function(aa){aa.setExtent(x(aa,"out"))};i=function(aa){aa.setExtent(x(aa,"left"))};C=function(aa){aa.setExtent(x(aa,"up"))};q=function(aa){aa.setExtent(x(aa,"right"))};n=function(aa){aa.setExtent(x(aa,"down"))};x=function(aa,ag){var aj=aa.extent,af=3,ad=4,ai,ab=aj.xmin,ae=aj.xmax,ah=aj.ymin,ac=aj.ymax;if(ag==="up"){ai=(ac-ah)/af;ah=ah-ai;ac=ac-ai}else{if(ag==="down"){ai=(ac-ah)/af;ah=ah+ai;ac=ac+ai}else{if(ag==="left"){ai=(ae-ab)/af;ab=ab-ai;ae=ae-ai}else{if(ag==="right"){ai=(ae-ab)/af;ab=ab+ai;ae=ae+ai}else{if(ag==="in"){ai=(ae-ab)/ad;ab=ab+ai;ae=ae-ai;ai=(ac-ah)/ad;ah=ah+ai;ac=ac-ai}else{if(ag==="out"){ai=(ae-ab)/ad;ab=ab-ai;ae=ae+ai;ai=(ac-ah)/ad;ah=ah-ai;ac=ac+ai}}}}}}aj=new g({xmin:ab,ymin:ah,xmax:ae,ymax:ac,spatialReference:{wkid:aa.spatialReference.wkid}});return aj};e=function(ab,ak,ah,ai,an,am){var af,aj,aa,ag,al,ae,ac=E(".esriPopupWrapper").find(".gcviz-wcag-close"),ad=(ab.vSideMenu!==1)?"upperright":"upperleft";if(typeof ai==="undefined"){al=U(ab)}else{if(typeof ai==="string"){af=ab.getLayer("gcviz-symbol");aj=af.graphics;ag=aj.length;while(ag--){aa=aj[ag];if(aa.key===ai){al=aa.geometry}}}else{al=ai}}ab.infoWindow.setTitle(ak);ab.infoWindow.setContent("<span>"+ah+"</span>");ab.infoWindow.anchor=ad;ae=ab.toScreen(al);ae.x=(ad==="upperright")?ae.x+an:ae.x-an;ae.y+=am;ab.infoWindow.show(ae);ac.focus()};Z=function(ae,ad){var ac,ab,af,aa;if(typeof ad!=="undefined"){ac=ae.getLayer("gcviz-symbol");ab=ac.graphics;aa=ab.length;while(aa--){af=ab[aa];if(ad===af.key){ac.remove(af)}}}ae.infoWindow.hide();u.focusMap(ae)};return{setProxy:O,createMap:t,createInset:J,addLayer:o,setScaleInfo:s,resizeMap:j,resizeCenterMap:S,zoomPoint:F,zoomFeature:M,getOverviewLayer:c,getMapCenter:U,manageScreenState:R,createMapMenu:Q,zoomIn:D,zoomOut:v,panLeft:i,panUp:C,panRight:q,panDown:n,showInfoWindow:e,hideInfoWindow:Z}})}());