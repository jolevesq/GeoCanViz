(function(){define(["jquery-private","gcviz-gismap","gcviz-gisgeo","gcviz-func","esri/layers/GraphicsLayer","esri/symbols/SimpleLineSymbol","esri/symbols/SimpleFillSymbol","esri/symbols/SimpleMarkerSymbol","esri/geometry/Point","esri/geometry/Polygon","esri/geometry/Polyline","esri/SpatialReference","esri/graphic","esri/request","esri/tasks/RelationshipQuery","dojo/DeferredList","esri/tasks/IdentifyTask","esri/tasks/IdentifyParameters"],function(z,P,m,R,l,q,x,A,Q,J,v,o,U,I,b,k,a,y){var e,u,h,N,w,H,r,S,n,L,D,i,C,j,E,f,c,G,M,g,p,t,B=[],O=0,F,T=new y(),d,K,s=0;e=function(X){var V=[255,255,102,125],W={type:"esriSLS",style:"esriSLSSolid",color:[255,255,0,255],width:1};f=X.vWkid;p=X;d=p.on("click",i);T.tolerance=3;T.returnGeometry=true;T.layerOption=y.LAYER_OPTION_VISIBLE;p.addLayer(new l({id:"gcviz-datagrid"}));c=X.getLayer("gcviz-datagrid");G=new A({type:"esriSMS",style:"esriSMSCircle",color:V,size:18,angle:0,xoffset:0,yoffset:0,outline:W});M=new q({type:"esriSLS",style:"esriSLSSolid",color:V,width:5,outline:W});g=new x({type:"esriSFS",style:"esriSFSSolid",color:V,outline:W})};u=function(V,W,X){I({url:V,content:{f:"json"},handleAs:"json",callbackParamName:"callback",load:function(ac){var Y,ad,ah=W.layerinfo,ag=W.linktable,aa=ah.id,Z=ac.spatialReference,ae=[],ab=ac.features,af=ab.length;if(ag.enable){ad=p.getLayer(aa);Y=new b();Y.outFields=ag.fields;Y.relationshipId=ag.relationship;Y.objectIds=R.getArrayLen(af);ad.queryRelatedFeatures(Y,function(ai){ae=h(ab,af,Z,aa,ai);N(ae,W,X)})}else{ae=h(ab,af,Z,aa);N(ae,W,X)}},error:function(Y){console.log("datagrid error: "+Y)}})};h=function(Z,ac,W,Y,X){var V,ag,ah,ab,af,ae,aa=[],ad=false;if(typeof X!=="undefined"){ad=true}while(ac--){ab=Z[ac];af=ab.geometry;if(typeof af.x!=="undefined"){ae=new Q({x:af.x,y:af.y,spatialReference:W})}else{if(typeof af.paths!=="undefined"){ae=new v({paths:af.paths,spatialReference:W})}else{ae=new J({rings:af.rings,spatialReference:W})}}ae.attributes=ab.attributes;ae.attributes.gcvizid=s+"-"+ac;ae.attributes.layerid=Y;if(ad){ag=X[ac+1].features;V=ag.length;ae.link=[];while(V--){ah=ag[V];ae.link.push(ah.attributes)}}aa.push(ae)}return aa};N=function(W,V,X){V.mapid=p.vIdName,W[0].attributes.layer=V;m.projectGeoms(W,f,X);s+=1};w=function(Y,V){var X,Z,W=Y.type;if(W==="point"){X=G}else{if(W==="polyline"){X=M}else{if(W==="polygon"){X=g}}}Z=new U(Y);Z.symbol=X;Z.key=V;return Z};H=function(V){var W=w(V,"zoom");L("zoom");c.add(W);P.zoomFeature(p,W)};r=function(Y){var X,Z,W=[],V=Y.length;while(V--){Z=w(Y[V],"zoom");W.push(Z)}L("zoom");X=esri.graphicsExtent(W);p.setExtent(X.expand(1.75))};S=function(W,V){var X=w(W,"sel"+V.table+"-"+V.feat);c.add(X)};n=function(V){var W=w(V,"popup");c.add(W)};L=function(X){var Y,W=c.graphics,V=W.length;while(V--){Y=W[V];if(Y.key===X){c.remove(Y)}}};D=function(W,V,X){K=X;F=V;t=new a(W);t.layerIndex=V;B[O]=t;O++};i=function(X){var W,V=[],Y=[],aa=B.length,Z=aa;T.geometry=X.mapPoint;T.mapExtent=p.extent;T.width=p.width;T.height=p.height;while(Z--){V[Z]=new dojo.Deferred();Y.push(V[Z])}W=new k(Y);W.then(C);while(aa--){T.layerIds=[B[aa].layerIndex];B[aa].execute(T,V[aa].callback)}};C=function(V){K(V)};j=function(){if(typeof d!=="undefined"){d.remove()}};E=function(){if(typeof d!=="undefined"){d.remove();d=p.on("click",i)}};return{initialize:e,getData:u,zoomFeature:H,zoomFeatures:r,selectFeature:S,selectFeaturePop:n,unselectFeature:L,createIdTask:D,removeEvtPop:j,addEvtPop:E}})}());