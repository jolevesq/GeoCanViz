/*
 *  https://github.com/rymor/esri-kinetic-panning
 */
define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/sniff","esri","esri/map","esri/MapNavigationManager","esri/MouseEvents","esri/TouchEvents","esri/utils","esri/geometry","esri/symbol","esri/graphic","esri/fx"],function(c,h,g,f,e,b,a,d){return c("utils.KineticPanning",null,{map:null,deceleration:0.85,displacementMouseMultiplier:10,displacementTouchMultiplier:25,minEndVelocity:0.1,eventModel:null,_dragInterval:null,_dragIntervalDuration:50,_kineticPanInterval:null,_kineticPanIntervalDuration:15,_mouseEnabled:false,_touchEnabled:false,_doKineticPanning:false,xVelocity:0,yVelocity:0,constructor:function(i){this.map=i;this._initEventModel();this._initDragIntervalDuration();this.map.navigationManager._panInit=h.hitch(this,function(k){var j=false;if(this.isKineticPanning){this._kineticPanEnd();j=true}f.MapNavigationManager.prototype._panInit.call(this.map.navigationManager,k);if(j){this.map.navigationManager._panStart(k)}});this.map.navigationManager._swipeInit=h.hitch(this,function(j){if(this.isKineticPanning){this._kineticPanEnd()}f.MapNavigationManager.prototype._swipeInit.call(this.map.navigationManager,j)})},_initEventModel:function(){if(f.isTouchEnabled){this.touchEvents=new d(this.map.__container,{map:this.map});this.eventModel="touch";this.enableTouch();this.touchEvents._fire=h.hitch(this.touchEvents,function(i,j){if(this[i]){this[i](j)}})}else{this.mouseEvents=new a(this.map.__container,{map:this.map});this.eventModel="mouse";this.mouseEvents._fire=h.hitch(this.mouseEvents,function(i,j){if(this[i]){this[i](j)}});this.enableMouse()}},_initDragIntervalDuration:function(){if(this._isLegacyBrowser()){this._dragIntervalDuration=this._dragIntervalDuration/5}},enableTouch:function(){if(!this._touchEnabled){this._touchEnabled=true;this._touchSwipeStartHandle=dojo.connect(this.touchEvents,"onSwipeStart",this,this._onMouseDragStart);this._touchSwipeHandle=dojo.connect(this.touchEvents,"onSwipeMove",this,this._onMouseDrag);this._touchSwipeEndHandle=dojo.connect(this.touchEvents,"onSwipeEnd",this,this._onMouseDragEnd);this._touchSwipeExtentChangeHandle=dojo.connect(this.map,"onExtentChange",this,this._kineticPanStart)}},disableTouch:function(){if(this._touchEnabled){this._touchEnabled=false;dojo.disconnect(this._touchSwipeStartHandle);dojo.disconnect(this._touchSwipeHandle);dojo.disconnect(this._touchSwipeEndHandle);dojo.disconnect(this._touchSwipeExtentChangeHandle);this._touchSwipeStartHandle=this._touchSwipeHandle=this._touchSwipeEndHandle=this._touchSwipeExtentChangeHandle=null}},enableMouse:function(){if(!this._mouseEnabled){this._mouseEnabled=true;this._mouseDragStartHandle=dojo.connect(this.mouseEvents,"onMouseDragStart",this,this._onMouseDragStart);this._mouseDragHandle=dojo.connect(this.mouseEvents,"onMouseDrag",this,this._onMouseDrag);this._mouseDragEndHandle=dojo.connect(this.mouseEvents,"onMouseDragEnd",this,this._onMouseDragEnd);this._mouseExtentChangeHandle=dojo.connect(this.map,"onExtentChange",this,this._kineticPanStart)}},disableMouse:function(){if(this._mouseEnabled){this._mouseEnabled=false;dojo.disconnect(this._mouseDragStartHandle);dojo.disconnect(this._mouseDragHandle);dojo.disconnect(this._mouseDragEndHandle);dojo.disconnect(this._mouseExtentChangeHandle);this._mouseDragStartHandle=this._mouseDragHandle=this._mouseDragEndHandle=this._mouseExtentChangeHandle=null}},_onMouseDragStart:function(i){this._mouseDragEvt=this._mouseDragStartEvt=i;this._doKineticPanning=true;this._lastDragEvt=i;if(!this._isLegacyBrowser()){this._dragInterval=setInterval(h.hitch(this,function(){this._setInitVelocity()}),this._dragIntervalDuration)}},_onMouseDrag:function(i){this._mouseDragEvt=i;if(this._isLegacyBrowser()){this._setInitVelocity()}},_onMouseDragEnd:function(i){this._mouseDragEndEvt=i},_kineticPanStart:function(i,k){if(this._doKineticPanning){clearInterval(this._dragInterval);if(this.xVelocity!==0&&this.yVelocity!==0){var j={screenPoint:this._mouseDragEvt.screenPoint};this.map.navigationManager._panInit(j);this.map.navigationManager._panStart(j);this._doKineticPanning=false;this.isKineticPanning=true;this._curPanningPoint={screenPoint:this._mouseDragStartEvt.screenPoint};this._kineticPanInterval=setInterval(h.hitch(this,function(){this._kineticPan()}),this._kineticPanIntervalDuration)}}},_kineticPan:function(){this.xVelocity*=this.deceleration;this.yVelocity*=this.deceleration;this._curPanningPoint.screenPoint.x+=this.xVelocity;this._curPanningPoint.screenPoint.y+=this.yVelocity;this.map.navigationManager._pan(this._curPanningPoint);if(!this._continuePanning()){this._kineticPanEnd()}},_kineticPanEnd:function(){if(this._kineticPanInterval){clearInterval(this._kineticPanInterval)}if(this._kineticTimeout){clearTimeout(this._kineticTimeout)}this.isKineticPanning=false;this.map.navigationManager._panEnd(this._curPanningPoint)},_continuePanning:function(){return(Math.abs(this.xVelocity)>this.minEndVelocity||Math.abs(this.yVelocity)>this.minEndVelocity)},_setInitVelocity:function(){this.xVelocity=this._calculateInitVelocity(this._lastDragEvt.screenPoint.x,this._mouseDragEvt.screenPoint.x);this.yVelocity=this._calculateInitVelocity(this._lastDragEvt.screenPoint.y,this._mouseDragEvt.screenPoint.y);this._lastDragEvt=this._mouseDragEvt},_calculateInitVelocity:function(k,j){if(k===j){return 0}else{var i;if(this.eventModel==="touch"){i=this.displacementTouchMultiplier}else{i=this.displacementMouseMultiplier}return((j-k)*i)/this._dragIntervalDuration}},_isLegacyBrowser:function(){return g("ie")<9}})});